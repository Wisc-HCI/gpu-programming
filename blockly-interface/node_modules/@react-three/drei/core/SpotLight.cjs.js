"use strict";var e=require("@babel/runtime/helpers/extends"),t=require("react"),r=require("three"),a=require("@react-three/fiber"),n=require("three-stdlib"),o=require("react-merge-refs"),i=require("../materials/SpotLightMaterial.cjs.js"),l=require("../helpers/glsl/DefaultSpotlightShadowShadows.glsl.js");function u(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var a=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,a.get?a:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var s=u(t);const c=e=>null==e?void 0:e.isSpotLight;function p({opacity:e=1,radiusTop:t,radiusBottom:n,depthBuffer:o,color:l="white",distance:u=5,angle:c=.15,attenuation:p=5,anglePower:d=5}){const h=s.useRef(null),m=a.useThree((e=>e.size)),f=a.useThree((e=>e.camera)),g=a.useThree((e=>e.viewport.dpr)),[w]=s.useState((()=>new i.SpotLightMaterial)),[v]=s.useState((()=>new r.Vector3));t=void 0===t?.1:t,n=void 0===n?7*c:n,a.useFrame((()=>{w.uniforms.spotPosition.value.copy(h.current.getWorldPosition(v)),h.current.lookAt(h.current.parent.target.getWorldPosition(v))}));const S=s.useMemo((()=>{const e=new r.CylinderGeometry(t,n,u,128,64,!0);return e.applyMatrix4((new r.Matrix4).makeTranslation(0,-u/2,0)),e.applyMatrix4((new r.Matrix4).makeRotationX(-Math.PI/2)),e}),[u,t,n]);return s.createElement(s.Fragment,null,s.createElement("mesh",{ref:h,geometry:S,raycast:()=>null},s.createElement("primitive",{object:w,attach:"material","uniforms-opacity-value":e,"uniforms-lightColor-value":l,"uniforms-attenuation-value":p,"uniforms-anglePower-value":d,"uniforms-depth-value":o,"uniforms-cameraNear-value":f.near,"uniforms-cameraFar-value":f.far,"uniforms-resolution-value":o?[m.width*g,m.height*g]:[0,0]})))}function d(e,t,n,o,i){const[[l,u]]=s.useState((()=>[new r.Vector3,new r.Vector3]));s.useLayoutEffect((()=>{if(!c(e.current))throw new Error("SpotlightShadow must be a child of a SpotLight");e.current.shadow.mapSize.set(n,o),e.current.shadow.needsUpdate=!0}),[e,n,o]),a.useFrame((()=>{if(!e.current)return;const r=e.current.position,a=e.current.target.position;u.copy(a).sub(r);var n=u.length();u.normalize().multiplyScalar(n*i),l.copy(r).add(u),t.current.position.copy(l),t.current.lookAt(e.current.target.position)}))}function h({distance:e=.4,alphaTest:t=.5,map:o,shader:i=l,width:u=512,height:c=512,scale:p=1,children:h,...m}){const f=s.useRef(null),g=m.spotlightRef,w=m.debug;d(g,f,u,c,e);const v=s.useMemo((()=>new r.WebGLRenderTarget(u,c,{format:r.RGBAFormat,encoding:r.LinearEncoding,stencilBuffer:!1})),[u,c]),S=s.useRef({uShadowMap:{value:o},uTime:{value:0}});s.useEffect((()=>{S.current.uShadowMap.value=o}),[o]);const E=s.useMemo((()=>new n.FullScreenQuad(new r.ShaderMaterial({uniforms:S.current,vertexShader:"\n          varying vec2 vUv;\n\n          void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n          }\n          ",fragmentShader:i}))),[i]);return s.useEffect((()=>()=>{E.material.dispose(),E.dispose()}),[E]),s.useEffect((()=>()=>v.dispose()),[v]),a.useFrame((({gl:e},t)=>{S.current.uTime.value+=t,e.setRenderTarget(v),E.render(e),e.setRenderTarget(null)})),s.createElement(s.Fragment,null,s.createElement("mesh",{ref:f,scale:p,castShadow:!0},s.createElement("planeGeometry",null),s.createElement("meshBasicMaterial",{transparent:!0,side:r.DoubleSide,alphaTest:t,alphaMap:v.texture,"alphaMap-wrapS":r.RepeatWrapping,"alphaMap-wrapT":r.RepeatWrapping,opacity:w?1:0},h)))}function m({distance:e=.4,alphaTest:t=.5,map:a,width:n=512,height:o=512,scale:i,children:l,...u}){const c=s.useRef(null),p=u.spotlightRef,h=u.debug;return d(p,c,n,o,e),s.createElement(s.Fragment,null,s.createElement("mesh",{ref:c,scale:i,castShadow:!0},s.createElement("planeGeometry",null),s.createElement("meshBasicMaterial",{transparent:!0,side:r.DoubleSide,alphaTest:t,alphaMap:a,"alphaMap-wrapS":r.RepeatWrapping,"alphaMap-wrapT":r.RepeatWrapping,opacity:h?1:0},l)))}const f=s.forwardRef((({opacity:t=1,radiusTop:r,radiusBottom:a,depthBuffer:n,color:i="white",distance:l=5,angle:u=.15,attenuation:c=5,anglePower:d=5,volumetric:h=!0,debug:m=!1,children:f,...g},w)=>{const v=s.useRef(null);return s.createElement("group",null,m&&v.current&&s.createElement("spotLightHelper",{args:[v.current]}),s.createElement("spotLight",e({ref:o([w,v]),angle:u,color:i,distance:l,castShadow:!0},g),h&&s.createElement(p,{debug:m,opacity:t,radiusTop:r,radiusBottom:a,depthBuffer:n,color:i,distance:l,angle:u,attenuation:c,anglePower:d})),f&&s.cloneElement(f,{spotlightRef:v,debug:m}))}));exports.SpotLight=f,exports.SpotLightShadow=function(e){return e.shader?s.createElement(h,e):s.createElement(m,e)};
