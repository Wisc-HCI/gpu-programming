"use strict";var t=require("react"),e=require("three"),r=require("@react-three/fiber");function n(t){var e=Object.create(null);return t&&Object.keys(t).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,n.get?n:{enumerable:!0,get:function(){return t[r]}})}})),e.default=t,Object.freeze(e)}var o=n(t),c=n(e),a=function(t){return t[t.NONE=0]="NONE",t[t.START=1]="START",t[t.ACTIVE=2]="ACTIVE",t}(a||{});const u=t=>t&&t.isOrthographicCamera,i=t=>1-Math.exp(-5*t)+.007*t,s=o.createContext(null);exports.Bounds=function({children:t,maxDuration:e=1,margin:n=1.2,observe:m,fit:p,clip:l,interpolateFunc:x=i,onFit:d}){const f=o.useRef(null),{camera:h,size:y,invalidate:g}=r.useThree(),v=r.useThree((t=>t.controls)),R=o.useRef(d);R.current=d;const w=o.useRef({camPos:new c.Vector3,camRot:new c.Quaternion,camZoom:1}),P=o.useRef({camPos:void 0,camRot:void 0,camZoom:void 0,camUp:void 0,target:void 0}),M=o.useRef(a.NONE),T=o.useRef(0),[V]=o.useState((()=>new c.Box3)),A=o.useMemo((()=>{function t(){const t=V.getSize(new c.Vector3),e=V.getCenter(new c.Vector3),r=Math.max(t.x,t.y,t.z),o=u(h)?4*r:r/(2*Math.atan(Math.PI*h.fov/360)),a=u(h)?4*r:o/h.aspect,i=n*Math.max(o,a);return{box:V,size:t,center:e,distance:i}}return{getSize:t,refresh(t){if((e=t)&&e.isBox3)V.copy(t);else{const e=t||f.current;if(!e)return this;e.updateWorldMatrix(!0,!0),V.setFromObject(e)}var e;if(V.isEmpty()){const t=h.position.length()||10;V.setFromCenterAndSize(new c.Vector3,new c.Vector3(t,t,t))}return w.current.camPos.copy(h.position),w.current.camRot.copy(h.quaternion),u(h)&&(w.current.camZoom=h.zoom),P.current.camPos=void 0,P.current.camRot=void 0,P.current.camZoom=void 0,P.current.camUp=void 0,P.current.target=void 0,this},reset(){const{center:e,distance:r}=t(),n=h.position.clone().sub(e).normalize();P.current.camPos=e.clone().addScaledVector(n,r),P.current.target=e.clone();const o=(new c.Matrix4).lookAt(P.current.camPos,P.current.target,h.up);return P.current.camRot=(new c.Quaternion).setFromRotationMatrix(o),M.current=a.START,T.current=0,this},moveTo(t){return P.current.camPos=Array.isArray(t)?new c.Vector3(...t):t.clone(),M.current=a.START,T.current=0,this},lookAt({target:t,up:e}){P.current.target=Array.isArray(t)?new c.Vector3(...t):t.clone(),P.current.camUp=e?Array.isArray(e)?new c.Vector3(...e):e.clone():h.up.clone();const r=(new c.Matrix4).lookAt(P.current.camPos||h.position,P.current.target,P.current.camUp);return P.current.camRot=(new c.Quaternion).setFromRotationMatrix(r),M.current=a.START,T.current=0,this},to({position:t,target:e}){return this.moveTo(t).lookAt({target:e})},fit(){if(!u(h))return this.reset();let t=0,e=0;const r=[new c.Vector3(V.min.x,V.min.y,V.min.z),new c.Vector3(V.min.x,V.max.y,V.min.z),new c.Vector3(V.min.x,V.min.y,V.max.z),new c.Vector3(V.min.x,V.max.y,V.max.z),new c.Vector3(V.max.x,V.max.y,V.max.z),new c.Vector3(V.max.x,V.max.y,V.min.z),new c.Vector3(V.max.x,V.min.y,V.max.z),new c.Vector3(V.max.x,V.min.y,V.min.z)],o=P.current.camPos||h.position,i=P.current.target||(null==v?void 0:v.target),s=P.current.camUp||h.up,m=i?(new c.Matrix4).lookAt(o,i,s).setPosition(o).invert():h.matrixWorldInverse;for(const n of r)n.applyMatrix4(m),t=Math.max(t,Math.abs(n.y)),e=Math.max(e,Math.abs(n.x));t*=2,e*=2;const p=(h.top-h.bottom)/t,l=(h.right-h.left)/e;return P.current.camZoom=Math.min(p,l)/n,M.current=a.START,T.current=0,R.current&&R.current(this.getSize()),this},clip(){const{distance:e}=t();return h.near=e/100,h.far=100*e,h.updateProjectionMatrix(),v&&(v.maxDistance=10*e,v.update()),g(),this}}}),[V,h,v,n,g]);o.useLayoutEffect((()=>{if(v){const t=()=>{if(v&&P.current.target&&M.current!==a.NONE){const t=(new c.Vector3).setFromMatrixColumn(h.matrix,2),e=w.current.camPos.distanceTo(v.target),r=(P.current.camPos||w.current.camPos).distanceTo(P.current.target),n=(1-T.current)*e+T.current*r;v.target.copy(h.position).addScaledVector(t,-n),v.update()}M.current=a.NONE};return v.addEventListener("start",t),()=>v.removeEventListener("start",t)}}),[v]);const z=o.useRef(0);return o.useLayoutEffect((()=>{(m||0==z.current++)&&(A.refresh(),p&&A.reset().fit(),l&&A.clip())}),[y,l,p,m,h,v]),r.useFrame(((t,r)=>{if(M.current===a.START)M.current=a.ACTIVE,g();else if(M.current===a.ACTIVE){if(T.current+=r/e,T.current>=1)P.current.camPos&&h.position.copy(P.current.camPos),P.current.camRot&&h.quaternion.copy(P.current.camRot),P.current.camUp&&h.up.copy(P.current.camUp),P.current.camZoom&&u(h)&&(h.zoom=P.current.camZoom),h.updateMatrixWorld(),h.updateProjectionMatrix(),v&&P.current.target&&(v.target.copy(P.current.target),v.update()),M.current=a.NONE;else{const t=x(T.current);P.current.camPos&&h.position.lerpVectors(w.current.camPos,P.current.camPos,t),P.current.camRot&&h.quaternion.slerpQuaternions(w.current.camRot,P.current.camRot,t),P.current.camUp&&h.up.set(0,1,0).applyQuaternion(h.quaternion),P.current.camZoom&&u(h)&&(h.zoom=(1-t)*w.current.camZoom+t*P.current.camZoom),h.updateMatrixWorld(),h.updateProjectionMatrix()}g()}})),o.createElement("group",{ref:f},o.createElement(s.Provider,{value:A},t))},exports.useBounds=function(){return o.useContext(s)};
