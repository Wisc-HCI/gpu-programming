"use strict";var e=require("@babel/runtime/helpers/extends"),r=require("react"),t=require("@react-three/fiber"),n=require("three"),a=require("./Instances.cjs.js");function u(e){var r=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}})),r.default=e,Object.freeze(r)}var c=u(r),s=u(n);const o=c.createContext(null);const f=c.forwardRef((({startFrame:r,endFrame:n,fps:u,frameName:f,textureDataURL:l,textureImageURL:m,loop:i,numberOfFrames:p,autoPlay:h,animationNames:d,onStart:w,onEnd:y,onLoopEnd:E,onFrame:S,play:g,pause:x,flipX:b,alphaTest:F,children:R,asSprite:v,offset:z,playBackwards:A,resetOnEnd:M,maxItems:j,instanceItems:O,...N},L)=>{const k=c.useRef(),I=c.useRef(null),T=c.useRef(),P=c.useRef(),q=c.useRef(window.performance.now()),C=c.useRef(),D=c.useRef(r||0),B=c.useRef(f||""),U=1e3/(u||30),[G,H]=c.useState(new s.Texture),W=c.useRef(0),[X,J]=c.useState([1,1,1]),K=b?-1:1,[Q,V]=c.useState(null==v||v),Y=c.useRef(x),Z=c.useRef(z),$=c.useRef(!1),_=c.useRef([]);function ee(){}const re=c.useMemo((()=>({current:Z.current,offset:Z.current,imageUrl:m,reset:ee,hasEnded:!1,ref:L})),[m]);c.useImperativeHandle(L,(()=>k.current),[]),c.useLayoutEffect((()=>{Z.current=z}),[z]);const te=(e,r)=>{const t=r/e;return P.current&&P.current.scale.set(1,t,1),[1,t,1]};c.useEffect((()=>{if(l&&m)!function(e,r,t){const n=new s.TextureLoader,a=fetch(e).then((e=>e.json())),u=new Promise((e=>{n.load(r,e)}));Promise.all([a,u]).then((e=>{t(e[0],e[1])}))}(l,m,ne);else if(m){const e=new s.TextureLoader;new Promise((r=>{e.load(m,r)})).then((e=>{ne(null,e)}))}}),[]),c.useEffect((()=>{V(null==v||v)}),[v]),c.useEffect((()=>{re.hasEnded=!1,I.current&&!0===A?D.current=I.current.frames.length-1:D.current=0}),[A]),c.useLayoutEffect((()=>{ue()}),[G,b]),c.useEffect((()=>{h&&(Y.current=!1)}),[h]),c.useEffect((()=>{if(B.current!==f&&f&&(D.current=0,B.current=f,re.hasEnded=!1,ue(),I.current)){const{w:e,h:r}=se(I.current.frames).sourceSize,t=te(e,r);J(t)}}),[f]);const ne=(e,r)=>{if(null===e){if(p){const e=r.image.width,t=r.image.height,n=e/p,a=t;if(C.current=r,W.current=p,A&&(D.current=p-1),I.current={frames:[],meta:{version:"1.0",size:{w:e,h:t},scale:"1"}},parseInt(n.toString(),10)===n)for(let e=0;e<p;e++)I.current.frames.push({frame:{x:e*n,y:0,w:n,h:a},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:n,h:a},sourceSize:{w:n,h:t}})}}else{I.current=e,I.current.frames=Array.isArray(e.frames)?e.frames:ae(),W.current=Array.isArray(e.frames)?e.frames.length:Object.keys(e.frames).length,C.current=r,A&&(D.current=W.current-1);const{w:t,h:n}=se(e.frames).sourceSize,a=te(t,n);J(a),T.current&&(T.current.map=r)}if(O)for(var t=0;t<O.length;t++){const e=Object.keys(I.current.frames),r=e[Math.floor(Math.random()*e.length)];_.current.push({key:t,frames:I.current.frames,selectedFrame:r,offset:{x:0,y:0}})}r.premultiplyAlpha=!1,H(r)},ae=()=>{const e={},r=I.current,t=d;if(t){for(let n=0;n<t.length;n++){e[t[n]]=[];for(const a in r.frames){const u=r.frames[a],c=u.frame,s=c.x,o=c.y,f=c.w,l=c.h,m=u.sourceSize.w,i=u.sourceSize.h;-1!==a.toLowerCase().indexOf(t[n].toLowerCase())&&e[t[n]].push({x:s,y:o,w:f,h:l,frame:c,sourceSize:{w:m,h:i}})}}return e}if(f){const e=[];for(const t in r.frames)e.push(r.frames[t]);return e}},ue=()=>{if(!I.current)return;const{meta:{size:e},frames:r}=I.current,{w:t,h:n}=Array.isArray(r)?r[0].sourceSize:f&&r[f]?r[f][0].sourceSize:{w:0,h:0};T.current.map.wrapS=T.current.map.wrapT=s.RepeatWrapping,T.current.map.center.set(0,0),T.current.map.repeat.set(1*K/(e.w/t),1/(e.h/n));const a=1/((e.h-1)/n);T.current.map.offset.x=0,T.current.map.offset.y=1-a,w&&w({currentFrameName:f,currentFrame:D.current})},ce=(e,r,t,n)=>{var a=void 0===z?re.current:z;const u=D.current;let c=0,s=0;te(e,r);const o=(t.w-1)/e,f=(t.h-1)/r;if(!n[u])return;const{frame:{x:l,y:m},sourceSize:{w:i,h:p}}=n[u],h=1/o,d=1/f;if(c=K>0?h*(l/i):h*(l/i)-T.current.map.repeat.x,s=Math.abs(1-d)-d*(m/p),T.current.map.offset.x=c,T.current.map.offset.y=s,null!=a){let e=Math.floor(a*n.length);e=Math.max(0,Math.min(e,n.length-1)),isNaN(e)&&(console.log("nan frame detected"),e=0),D.current=e}else A?D.current-=1:D.current+=1};t.useFrame(((e,t)=>{var a,u;null!=(a=I.current)&&a.frames&&null!=(u=T.current)&&u.map&&(Y.current||re.hasEnded||!h&&!g||((()=>{const e=window.performance.now(),t=e-q.current,{meta:{size:a},frames:u}=I.current,{w:c,h:s}=se(u).sourceSize,o=Array.isArray(u)?u:f?u[f]:[],l=n||o.length-1;var m=void 0===z?re.current:z,p=A?D.current<0:D.current>l,h=A?D.current===l:0===D.current,d=A?D.current<0:D.current>=l;if(p){if(D.current=i&&null!=r?r:0,A&&(D.current=l),i?null==E||E({currentFrameName:f,currentFrame:D.current}):(null==y||y({currentFrameName:f,currentFrame:D.current}),m||console.log("will end"),re.hasEnded=!M,M&&(Y.current=!0)),!i)return}else h&&(null==w||w({currentFrameName:f,currentFrame:D.current}));void 0!==m&&d?!1===$.current&&(null==y||y({currentFrameName:f,currentFrame:D.current}),$.current=!0):$.current=!1,t<=U||(q.current=e-t%U,ce(c,s,a,o))})(),S&&S({currentFrameName:B.current,currentFrame:D.current})))}));const se=e=>{if(Array.isArray(e))return e[0];if("object"==typeof e&&null!==e){const r=Object.keys(e);return f?e[f][0]:e[r[0]][0]}return{w:0,h:0}};return c.createElement("group",e({},N,{ref:k}),c.createElement(o.Provider,{value:re},c.createElement(c.Suspense,{fallback:null},Q&&c.createElement("sprite",{ref:P,scale:X},c.createElement("spriteMaterial",{toneMapped:!1,ref:T,map:G,transparent:!0,alphaTest:null!=F?F:0})),!Q&&c.createElement(a.Instances,{limit:j},c.createElement("planeGeometry",{args:[1,1]}),c.createElement("meshBasicMaterial",{toneMapped:!1,side:s.DoubleSide,ref:T,map:G,transparent:!0,alphaTest:null!=F?F:0}),(null!=O?O:[0]).map(((e,r)=>{const t=G.clone();return T.current&&_.current[r]&&t.offset.set(_.current[r].offset.x,_.current[r].offset.y),c.createElement(a.Instance,{key:r,ref:P,position:e,scale:X},c.createElement("meshBasicMaterial",{toneMapped:!1,side:s.DoubleSide,map:t,transparent:!0,alphaTest:null!=F?F:0}))})))),R))}));exports.SpriteAnimator=f,exports.useSpriteAnimator=function(){return c.useContext(o)};
