"use strict";var e=require("@babel/runtime/helpers/extends"),r=require("three"),t=require("react"),n=require("@react-three/fiber"),a=require("./useIntersect.cjs.js"),i=require("./useFBO.cjs.js"),l=require("./RenderTexture.cjs.js"),o=require("./shaderMaterial.cjs.js"),s=require("three-stdlib"),u=require("../helpers/constants.cjs.js");function v(e){var r=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}})),r.default=e,Object.freeze(r)}var c=v(r),m=v(t);const d=o.shaderMaterial({blur:0,map:null,sdf:null,blend:0,size:0,resolution:new c.Vector2},"varying vec2 vUv;\n   void main() {\n     gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n     vUv = uv;\n   }",`uniform sampler2D sdf;\n   uniform sampler2D map;\n   uniform float blur;\n   uniform float size;\n   uniform float time;\n   uniform vec2 resolution;\n   varying vec2 vUv;\n   #include <packing>\n   void main() {\n     vec2 uv = gl_FragCoord.xy / resolution.xy;\n     vec4 t = texture2D(map, uv);\n     float k = blur;\n     float d = texture2D(sdf, vUv).r/size;\n     float alpha = 1.0 - smoothstep(0.0, 1.0, clamp(d/k + 1.0, 0.0, 1.0));\n     gl_FragColor = vec4(t.rgb, blur == 0.0 ? t.a : t.a * alpha);\n     #include <tonemapping_fragment>\n     #include <${u.version>=154?"colorspace_fragment":"encodings_fragment"}>\n   }`),f=m.forwardRef((({children:r,events:t,blur:o=0,eventPriority:s=0,renderPriority:u=0,worldUnits:v=!1,resolution:f=512,...p},F)=>{n.extend({PortalMaterialImpl:d});const h=m.useRef(null),{scene:y,gl:b,size:w,viewport:M,setEvents:U}=n.useThree(),T=i.useFBO(f,f),[R,S]=m.useState(0);n.useFrame((()=>{const e=h.current.blend>0?Math.max(1,u):0;R!==e&&S(e)})),m.useEffect((()=>{void 0!==t&&U({enabled:!t})}),[t]);const[D,_]=m.useState(!0),j=a.useIntersect(_);m.useLayoutEffect((()=>{var e;j.current=null==(e=h.current)?void 0:e.__r3f.parent}),[]),m.useLayoutEffect((()=>{if(j.current&&o&&null===h.current.sdf){const e=new c.Mesh(j.current.geometry,new c.MeshBasicMaterial),r=(new c.Box3).setFromBufferAttribute(e.geometry.attributes.position),t=new c.OrthographicCamera(r.min.x*(1+2/f),r.max.x*(1+2/f),r.max.y*(1+2/f),r.min.y*(1+2/f),.1,1e3);t.position.set(0,0,1),t.lookAt(0,0,0),b.setRenderTarget(T),b.render(e,t);const n=x(f,f,b)(T.texture),a=new Float32Array(f*f);b.readRenderTargetPixels(n,0,0,f,f,a);let i=1/0;for(let e=0;e<a.length;e++)a[e]<i&&(i=a[e]);i=-i,h.current.size=i,h.current.sdf=n.texture,b.setRenderTarget(null)}}),[f,o]),m.useImperativeHandle(F,(()=>h.current));const P=m.useCallback(((e,r,t)=>{var n;if(!j.current)return!1;if(r.pointer.set(e.offsetX/r.size.width*2-1,-e.offsetY/r.size.height*2+1),r.raycaster.setFromCamera(r.pointer,r.camera),0===(null==(n=h.current)?void 0:n.blend)){const[e]=r.raycaster.intersectObject(j.current);if(!e)return r.raycaster.camera=void 0,!1}}),[]);return m.createElement("portalMaterialImpl",e({ref:h,blur:o,blend:0,resolution:[w.width*M.dpr,w.height*M.dpr],attach:"material"},p),m.createElement(l.RenderTexture,{attach:"map",frames:D?1/0:0,eventPriority:s,renderPriority:u,compute:P},r,m.createElement(g,{events:t,rootScene:y,priority:R,material:h,worldUnits:v})))}));function g({events:e,rootScene:r,material:t,priority:a,worldUnits:l}){const o=n.useThree((e=>e.scene)),v=n.useThree((e=>e.setEvents)),d=i.useFBO(),f=i.useFBO();m.useLayoutEffect((()=>{o.matrixAutoUpdate=!1}),[]),m.useEffect((()=>{void 0!==e&&v({enabled:e})}),[e]);const[g,x]=m.useMemo((()=>{const e={value:0};return[new s.FullScreenQuad(new c.ShaderMaterial({uniforms:{a:{value:d.texture},b:{value:f.texture},blend:e},vertexShader:"\n          varying vec2 vUv;\n          void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n          }",fragmentShader:`\n          uniform sampler2D a;\n          uniform sampler2D b;\n          uniform float blend;\n          varying vec2 vUv;\n          #include <packing>\n          void main() {\n            vec4 ta = texture2D(a, vUv);\n            vec4 tb = texture2D(b, vUv);\n            gl_FragColor = mix(tb, ta, blend);\n            #include <tonemapping_fragment>\n            #include <${u.version>=154?"colorspace_fragment":"encodings_fragment"}>\n          }`})),e]}),[]);return n.useFrame((e=>{var n;let i=null==t||null==(n=t.current)?void 0:n.__r3f.parent;if(i){var s,u,v,c;if(l)o.matrixWorld.identity();else a&&1===(null==(s=t.current)?void 0:s.blend)&&i.updateWorldMatrix(!0,!1),o.matrixWorld.copy(i.matrixWorld);if(a)(null==(u=t.current)?void 0:u.blend)>0&&(null==(v=t.current)?void 0:v.blend)<1?(x.value=t.current.blend,e.gl.setRenderTarget(d),e.gl.render(o,e.camera),e.gl.setRenderTarget(f),e.gl.render(r,e.camera),e.gl.setRenderTarget(null),g.render(e.gl)):1===(null==(c=t.current)?void 0:c.blend)&&e.gl.render(o,e.camera)}}),a),m.createElement(m.Fragment,null)}const x=(e,r,t)=>{let n=new c.WebGLRenderTarget(e,r,{minFilter:c.LinearMipmapLinearFilter,magFilter:c.LinearFilter,type:c.FloatType,format:c.RedFormat,generateMipmaps:!0}),a=new c.WebGLRenderTarget(e,r,{minFilter:c.NearestFilter,magFilter:c.NearestFilter}),i=new c.WebGLRenderTarget(e,r,{minFilter:c.NearestFilter,magFilter:c.NearestFilter}),l=new c.WebGLRenderTarget(e,r,{minFilter:c.NearestFilter,magFilter:c.NearestFilter}),o=new c.WebGLRenderTarget(e,r,{minFilter:c.NearestFilter,magFilter:c.NearestFilter}),u=new c.WebGLRenderTarget(e,r,{minFilter:c.NearestFilter,magFilter:c.NearestFilter,type:c.FloatType,format:c.RedFormat}),v=new c.WebGLRenderTarget(e,r,{minFilter:c.NearestFilter,magFilter:c.NearestFilter,type:c.FloatType,format:c.RedFormat});const m=new s.FullScreenQuad(new c.ShaderMaterial({uniforms:{tex:{value:null}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        uniform sampler2D tex;\n        varying vec2 vUv;\n        #include <packing>\n        void main() {\n          gl_FragColor = pack2HalfToRGBA(vUv * (round(texture2D(tex, vUv).x)));\n        }"})),d=new s.FullScreenQuad(new c.ShaderMaterial({uniforms:{tex:{value:null}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        uniform sampler2D tex;\n        varying vec2 vUv;\n        #include <packing>\n        void main() {\n          gl_FragColor = pack2HalfToRGBA(vUv * (1.0 - round(texture2D(tex, vUv).x)));\n        }"})),f=new s.FullScreenQuad(new c.ShaderMaterial({uniforms:{tex:{value:null},offset:{value:0},level:{value:0},maxSteps:{value:0}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:`\n        varying vec2 vUv;\n        uniform sampler2D tex;\n        uniform float offset;\n        uniform float level;\n        uniform float maxSteps;\n        #include <packing>\n        void main() {\n          float closestDist = 9999999.9;\n          vec2 closestPos = vec2(0.0);\n          for (float x = -1.0; x <= 1.0; x += 1.0) {\n            for (float y = -1.0; y <= 1.0; y += 1.0) {\n              vec2 voffset = vUv;\n              voffset += vec2(x, y) * vec2(${1/e}, ${1/r}) * offset;\n              vec2 pos = unpackRGBATo2Half(texture2D(tex, voffset));\n              float dist = distance(pos.xy, vUv);\n              if(pos.x != 0.0 && pos.y != 0.0 && dist < closestDist) {\n                closestDist = dist;\n                closestPos = pos;\n              }\n            }\n          }\n          gl_FragColor = pack2HalfToRGBA(closestPos);\n        }`})),g=new s.FullScreenQuad(new c.ShaderMaterial({uniforms:{tex:{value:null},size:{value:new c.Vector2(e,r)}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        varying vec2 vUv;\n        uniform sampler2D tex;\n        uniform vec2 size;\n        #include <packing>\n        void main() {\n          gl_FragColor = vec4(distance(size * unpackRGBATo2Half(texture2D(tex, vUv)), size * vUv), 0.0, 0.0, 0.0);\n        }"})),x=new s.FullScreenQuad(new c.ShaderMaterial({uniforms:{inside:{value:v.texture},outside:{value:u.texture},tex:{value:null}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        varying vec2 vUv;\n        uniform sampler2D inside;\n        uniform sampler2D outside;\n        uniform sampler2D tex;\n        #include <packing>\n        void main() {\n          float i = texture2D(inside, vUv).x;\n          float o =texture2D(outside, vUv).x;\n          if (texture2D(tex, vUv).x == 0.0) {\n            gl_FragColor = vec4(o, 0.0, 0.0, 0.0);\n          } else {\n            gl_FragColor = vec4(-i, 0.0, 0.0, 0.0);\n          }\n        }"}));return s=>{let p=n;s.minFilter=c.NearestFilter,s.magFilter=c.NearestFilter,m.material.uniforms.tex.value=s,t.setRenderTarget(a),m.render(t);const F=Math.ceil(Math.log(Math.max(e,r))/Math.log(2));let h=a,y=null;for(let e=0;e<F;e++){const r=Math.pow(2,F-e-1);y=h===a?l:a,f.material.uniforms.level.value=e,f.material.uniforms.maxSteps.value=F,f.material.uniforms.offset.value=r,f.material.uniforms.tex.value=h.texture,t.setRenderTarget(y),f.render(t),h=y}t.setRenderTarget(u),g.material.uniforms.tex.value=y.texture,g.render(t),d.material.uniforms.tex.value=s,t.setRenderTarget(i),d.render(t),h=i;for(let e=0;e<F;e++){const r=Math.pow(2,F-e-1);y=h===i?o:i,f.material.uniforms.level.value=e,f.material.uniforms.maxSteps.value=F,f.material.uniforms.offset.value=r,f.material.uniforms.tex.value=h.texture,t.setRenderTarget(y),f.render(t),h=y}return t.setRenderTarget(v),g.material.uniforms.tex.value=y.texture,g.render(t),t.setRenderTarget(p),x.material.uniforms.tex.value=s,x.render(t),t.setRenderTarget(null),p}};exports.MeshPortalMaterial=f;
