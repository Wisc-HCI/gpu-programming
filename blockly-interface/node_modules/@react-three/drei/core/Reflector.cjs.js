"use strict";var e=require("@babel/runtime/helpers/extends"),t=require("react"),r=require("three"),a=require("@react-three/fiber"),n=require("react-merge-refs"),s=require("../materials/BlurPass.cjs.js"),o=require("../materials/MeshReflectorMaterial.cjs.js");function i(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var a=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,a.get?a:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var l=i(t);const u=l.forwardRef((({mixBlur:t=0,mixStrength:i=.5,resolution:u=256,blur:c=[0,0],args:d=[1,1],minDepthThreshold:p=.9,maxDepthThreshold:m=1,depthScale:h=0,depthToBlurRatioBias:x=.25,mirror:f=0,children:M,debug:w=0,distortion:T=1,mixContrast:b=1,distortionMap:y,...g},S)=>{a.extend({MeshReflectorMaterial:o.MeshReflectorMaterial}),l.useEffect((()=>{console.warn("Reflector has been deprecated and will be removed next major. Replace it with <MeshReflectorMaterial />!")}),[]);const R=a.useThree((({gl:e})=>e)),j=a.useThree((({camera:e})=>e)),B=a.useThree((({scene:e})=>e)),D=(c=Array.isArray(c)?c:[c,c])[0]+c[1]>0,v=l.useRef(null),[F]=l.useState((()=>new r.Plane)),[P]=l.useState((()=>new r.Vector3)),[V]=l.useState((()=>new r.Vector3)),[W]=l.useState((()=>new r.Vector3)),[E]=l.useState((()=>new r.Matrix4)),[O]=l.useState((()=>new r.Vector3(0,0,-1))),[U]=l.useState((()=>new r.Vector4)),[q]=l.useState((()=>new r.Vector3)),[C]=l.useState((()=>new r.Vector3)),[L]=l.useState((()=>new r.Vector4)),[k]=l.useState((()=>new r.Matrix4)),[z]=l.useState((()=>new r.PerspectiveCamera)),A=l.useCallback((()=>{if(V.setFromMatrixPosition(v.current.matrixWorld),W.setFromMatrixPosition(j.matrixWorld),E.extractRotation(v.current.matrixWorld),P.set(0,0,1),P.applyMatrix4(E),q.subVectors(V,W),q.dot(P)>0)return;q.reflect(P).negate(),q.add(V),E.extractRotation(j.matrixWorld),O.set(0,0,-1),O.applyMatrix4(E),O.add(W),C.subVectors(V,O),C.reflect(P).negate(),C.add(V),z.position.copy(q),z.up.set(0,1,0),z.up.applyMatrix4(E),z.up.reflect(P),z.lookAt(C),z.far=j.far,z.updateMatrixWorld(),z.projectionMatrix.copy(j.projectionMatrix),k.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),k.multiply(z.projectionMatrix),k.multiply(z.matrixWorldInverse),k.multiply(v.current.matrixWorld),F.setFromNormalAndCoplanarPoint(P,V),F.applyMatrix4(z.matrixWorldInverse),U.set(F.normal.x,F.normal.y,F.normal.z,F.constant);const e=z.projectionMatrix;L.x=(Math.sign(U.x)+e.elements[8])/e.elements[0],L.y=(Math.sign(U.y)+e.elements[9])/e.elements[5],L.z=-1,L.w=(1+e.elements[10])/e.elements[14],U.multiplyScalar(2/U.dot(L)),e.elements[2]=U.x,e.elements[6]=U.y,e.elements[10]=U.z+1,e.elements[14]=U.w}),[]),[I,G,_,H]=l.useMemo((()=>{const e={type:r.HalfFloatType,minFilter:r.LinearFilter,magFilter:r.LinearFilter},a=new r.WebGLRenderTarget(u,u,e);a.depthBuffer=!0,a.depthTexture=new r.DepthTexture(u,u),a.depthTexture.format=r.DepthFormat,a.depthTexture.type=r.UnsignedShortType;const n=new r.WebGLRenderTarget(u,u,e);return[a,n,new s.BlurPass({gl:R,resolution:u,width:c[0],height:c[1],minDepthThreshold:p,maxDepthThreshold:m,depthScale:h,depthToBlurRatioBias:x}),{mirror:f,textureMatrix:k,mixBlur:t,tDiffuse:a.texture,tDepth:a.depthTexture,tDiffuseBlur:n.texture,hasBlur:D,mixStrength:i,minDepthThreshold:p,maxDepthThreshold:m,depthScale:h,depthToBlurRatioBias:x,transparent:!0,debug:w,distortion:T,distortionMap:y,mixContrast:b,"defines-USE_BLUR":D?"":void 0,"defines-USE_DEPTH":h>0?"":void 0,"defines-USE_DISTORTION":y?"":void 0}]}),[R,c,k,u,f,D,t,i,p,m,h,x,w,T,y,b]);return a.useFrame((()=>{if(null==v||!v.current)return;v.current.visible=!1;const e=R.xr.enabled,t=R.shadowMap.autoUpdate;A(),R.xr.enabled=!1,R.shadowMap.autoUpdate=!1,R.setRenderTarget(I),R.state.buffers.depth.setMask(!0),R.autoClear||R.clear(),R.render(B,z),D&&_.render(R,I,G),R.xr.enabled=e,R.shadowMap.autoUpdate=t,v.current.visible=!0,R.setRenderTarget(null)})),l.createElement("mesh",e({ref:n([v,S])},g),l.createElement("planeGeometry",{args:d}),M?M("meshReflectorMaterial",H):l.createElement("meshReflectorMaterial",H))}));exports.Reflector=u;
